{{ 'component-collection.css' | asset_url | stylesheet_tag }}
<script src="{{ 'collection-filters.js' | asset_url }}" defer="defer"></script>

{% assign sort_by = collection.sort_by | default: collection.default_sort_by %}
{% case sort_by %}
  {% when 'manual' %}
    {% assign current_sort_label = 'FEATURED' %}
  {% when 'best-selling' %}
    {% assign current_sort_label = 'BEST SELLING' %}
  {% when 'title-ascending' %}
    {% assign current_sort_label = 'A TO Z' %}
  {% when 'title-descending' %}
    {% assign current_sort_label = 'Z TO A' %}
  {% when 'price-ascending' %}
    {% assign current_sort_label = 'PRICE: LOW TO HIGH' %}
  {% when 'price-descending' %}
    {% assign current_sort_label = 'PRICE: HIGH TO LOW' %}
  {% when 'created-descending' %}
    {% assign current_sort_label = 'NEWEST' %}
  {% when 'created-ascending' %}
    {% assign current_sort_label = 'OLDEST' %}
  {% else %}
    {% assign current_sort_label = sort_by | upcase %}
{% endcase %}

<div class="collection" data-section-id="{{ section.id }}">
  <div class="collection__inner page-width">
    <h1 class="collection__title">{{ collection.title | escape | upcase }}</h1>

    <div class="collection__filters-bar">
      {% assign has_filters = section.settings.enable_filtering and collection.filters != empty %}
      {% if has_filters %}
        <div class="collection__filters-primary">
          <button type="button" class="collection__filters-trigger" data-mobile-filter-trigger aria-expanded="false" aria-controls="FacetFiltersForm-{{ section.id }}">
            <span>{{ 'products.facets.filter_label' | t | default: 'Filters' | upcase }}</span>
            {% render 'icon-chevron' %}
          </button>

          <div class="collection__filters-container" data-filters-container>
            <div class="collection__filters-modal-header">
              <span class="collection__filters-modal-title">{{ 'products.facets.filter_label' | t | default: 'Filters' | upcase }}</span>
              <button type="button" class="collection__filters-close" data-mobile-filter-close aria-label="{{ 'general.accessibility.close_modal' | t | default: 'Close filters' | upcase }}">
                {% render 'icon-close' %}
              </button>
            </div>

            <facet-filters-form class="collection__filters-form">
              <form id="FacetFiltersForm-{{ section.id }}" class="collection__filters-fields" data-filters-form>
                <div class="collection__filters-list">
                  {% assign filter_targets = 'product type|colour|color|size' | split: '|' %}
                  {% assign rendered_filters = '|' %}
                  {% for target in filter_targets %}
                    {% assign normalized_target = target %}
                    {% if target == 'color' %}
                      {% assign normalized_target = 'colour' %}
                    {% endif %}

                    {% assign lookup_key = '|' | append: normalized_target | append: '|' %}
                    {% if rendered_filters contains lookup_key %}
                      {% continue %}
                    {% endif %}

                    {% assign matching_filter = blank %}
                    {% for filter in collection.filters %}
                      {% if filter.label %}
                        {% assign filter_label = filter.label | downcase %}
                        {% if filter_label == target %}
                          {% assign matching_filter = filter %}
                          {% break %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}

                    {% if matching_filter != blank %}
                      {% assign rendered_filters = rendered_filters | append: normalized_target | append: '|' %}
                      {% assign dropdown_id = 'CollectionFilter-' | append: section.id | append: '-' | append: normalized_target | replace: ' ', '-' | replace: '/', '-' | replace: '&', '-' | replace: '--', '-' | downcase %}
                      <div class="collection__filter" data-filter>
                        <button type="button" class="collection__filter-button" aria-expanded="false" aria-controls="{{ dropdown_id }}" data-filter-button>
                          <span class="collection__filter-label">{{ matching_filter.label | upcase }}</span>
                          {% render 'icon-chevron' %}
                        </button>
                        <div class="collection__filter-dropdown" id="{{ dropdown_id }}" data-filter-dropdown>
                          {% if matching_filter.type == 'list' %}
                            <ul class="collection__filter-options" role="list">
                              {% for value in matching_filter.values %}
                                {% assign option_disabled = value.count == 0 and value.active == false %}
                                {% assign option_id = dropdown_id | append: '-option-' | append: forloop.index %}
                                <li class="collection__filter-option">
                                  <label class="collection__filter-option-label{% if option_disabled %} is-disabled{% endif %}" for="{{ option_id }}">
                                    <input
                                      type="checkbox"
                                      id="{{ option_id }}"
                                      name="{{ value.param_name }}"
                                      value="{{ value.value }}"
                                      {% if value.active %}checked{% endif %}
                                      {% if option_disabled %}disabled{% endif %}
                                      class="collection__filter-checkbox"
                                    >
                                    <span class="collection__filter-option-text">{{ value.label | escape | upcase }}</span>
                                  </label>
                                </li>
                              {% endfor %}
                            </ul>
                          {% elsif matching_filter.type == 'price_range' %}
                            <div class="collection__filter-price">
                              <label class="collection__filter-option-label" for="{{ dropdown_id }}-min">
                                <span>{{ 'products.facets.from' | t | default: 'From' | upcase }}</span>
                                <input
                                  type="number"
                                  id="{{ dropdown_id }}-min"
                                  name="{{ matching_filter.min_value.param_name }}"
                                  {% if matching_filter.min_value.value %}value="{{ matching_filter.min_value.value | divided_by: 100.0 }}"{% endif %}
                                  min="0"
                                  max="{{ matching_filter.range_max | divided_by: 100.0 }}"
                                  class="collection__filter-input"
                                >
                              </label>
                              <label class="collection__filter-option-label" for="{{ dropdown_id }}-max">
                                <span>{{ 'products.facets.to' | t | default: 'To' | upcase }}</span>
                                <input
                                  type="number"
                                  id="{{ dropdown_id }}-max"
                                  name="{{ matching_filter.max_value.param_name }}"
                                  {% if matching_filter.max_value.value %}value="{{ matching_filter.max_value.value | divided_by: 100.0 }}"{% endif %}
                                  min="0"
                                  max="{{ matching_filter.range_max | divided_by: 100.0 }}"
                                  class="collection__filter-input"
                                >
                              </label>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>

                <div class="collection__filters-footer">
                  <button type="submit" class="collection__filters-apply">
                    {{ 'products.facets.apply' | t | default: 'Apply Filters' | upcase }}
                  </button>
                </div>
              </form>
            </facet-filters-form>
          </div>
        </div>
      {% endif %}

      <div class="collection__meta">
        {% if section.settings.show_product_count %}
          <span class="collection__count">{{ collection.products_count }} {{ 'general.items' | t | default: 'Items' | upcase }}</span>
        {% endif %}

        {% if section.settings.enable_sorting %}
          <span class="collection__meta-divider" aria-hidden="true"></span>
          <div class="collection__sort" data-sort>
            <button type="button" class="collection__sort-toggle" data-sort-toggle aria-expanded="false" data-current-sort="{{ sort_by }}">
              <span class="collection__sort-label">{{ 'products.sorting.title' | t | default: 'Sort' | upcase }}</span>
              <span class="collection__sort-value">{{ current_sort_label }}</span>
              {% render 'icon-chevron' %}
            </button>
            <div class="collection__sort-dropdown" data-sort-dropdown>
              <button type="button" class="collection__sort-option{% if sort_by == 'manual' %} is-active{% endif %}" data-sort-value="manual">FEATURED</button>
              <button type="button" class="collection__sort-option{% if sort_by == 'best-selling' %} is-active{% endif %}" data-sort-value="best-selling">BEST SELLING</button>
              <button type="button" class="collection__sort-option{% if sort_by == 'title-ascending' %} is-active{% endif %}" data-sort-value="title-ascending">A TO Z</button>
              <button type="button" class="collection__sort-option{% if sort_by == 'title-descending' %} is-active{% endif %}" data-sort-value="title-descending">Z TO A</button>
              <button type="button" class="collection__sort-option{% if sort_by == 'price-ascending' %} is-active{% endif %}" data-sort-value="price-ascending">PRICE: LOW TO HIGH</button>
              <button type="button" class="collection__sort-option{% if sort_by == 'price-descending' %} is-active{% endif %}" data-sort-value="price-descending">PRICE: HIGH TO LOW</button>
              <button type="button" class="collection__sort-option{% if sort_by == 'created-descending' %} is-active{% endif %}" data-sort-value="created-descending">NEWEST</button>
              <button type="button" class="collection__sort-option{% if sort_by == 'created-ascending' %} is-active{% endif %}" data-sort-value="created-ascending">OLDEST</button>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    {% paginate collection.products by section.settings.products_per_page %}
      <div class="collection__grid" id="CollectionGrid-{{ section.id }}">
        {% for product in paginate.items %}
          {% render 'product-card', product: product %}
        {% else %}
          <div class="collection__empty">
            <p>{{ 'sections.collection.empty' | t | default: 'No products found' | upcase }}</p>
          </div>
        {% endfor %}
      </div>

      {% if paginate.pages > 1 %}
        {% render 'pagination', paginate: paginate %}
      {% endif %}
    {% endpaginate %}
  </div>

  {% if has_filters %}
    <div class="collection__filters-overlay" data-filters-overlay></div>
  {% endif %}
</div>

{% schema %}
{
  "name": "Collection products",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24,
      "label": "Products per page"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 3,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Number of columns on desktop"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "1 column"
        },
        {
          "value": "2",
          "label": "2 columns"
        }
      ],
      "default": "2",
      "label": "Number of columns on mobile"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "default": true,
      "label": "Enable filtering"
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "default": true,
      "label": "Enable sorting"
    },
    {
      "type": "checkbox",
      "id": "show_product_count",
      "default": true,
      "label": "Show product count"
    }
  ]
}
{% endschema %}
